<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MENA Releases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root { --bg:#0f1115; --panel:#151922; --text:#e8ecf1; --muted:#9aa3ad; --border:#222938; --accent:#6ea8fe; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#141823,#0f1115);position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:1.6rem}
    .sub{margin-top:6px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .control{display:flex;flex-direction:column;gap:6px;min-width:180px}
    label{font-size:.85rem;color:var(--muted)}
    input,select,button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);outline:none}
    input:focus,select:focus,button:focus{border-color:var(--accent);box-shadow:0 0 0 3px #6ea8fe22}
    button{cursor:pointer}
    main{max-width:1400px;margin:18px auto;padding:0 16px 40px}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media (max-width:1100px){ .layout{grid-template-columns:1fr} }
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .meta{color:var(--muted);font-size:.9rem}
    .error{color:#ffb3b3;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1e2432;padding:10px 8px;text-align:left;white-space:nowrap}
    th{color:#cbd5e1;font-weight:600;user-select:none;cursor:pointer}
    th .dir{opacity:.8;margin-left:4px}
    tbody tr:hover{background:#161c27}
    .toolbar{display:flex;align-items:center;gap:10px;margin:10px 0}
    .grow{flex:1}
    .pager{display:flex;gap:8px;align-items:center}
    .pager button[disabled]{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <h1>MENA Releases</h1>
    <div class="sub">brought to you by <strong>MENAMUSICINDUSTRY</strong> meme page. Data powered by <strong>MusicBrainz</strong>.</div>

    <div class="controls">
      <div class="control" style="min-width:260px;flex:1">
        <label for="q">Search by Artist Name</label>
        <input id="q" type="text" placeholder="Type an artist name…">
      </div>
      <div class="control">
        <label for="country">Artist Country (multi-select)</label>
        <select id="country" multiple size="6" aria-label="Filter by country"></select>
      </div>
      <div class="control">
        <label for="start">Release Date (start)</label>
        <input id="start" type="date">
      </div>
      <div class="control">
        <label for="end">Release Date (end)</label>
        <input id="end" type="date">
      </div>
      <div class="control" style="align-self:flex-end">
        <button id="clear">Clear filters</button>
      </div>
      <div class="control" style="min-width:320px">
        <label>Status</label>
        <div id="status" class="meta">Loading…</div>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- Left: results table with sorting + pagination -->
      <div class="panel">
        <div class="toolbar">
          <div class="meta grow" id="summary">0 shown</div>
          <div class="pager">
            <button id="prev">Prev</button>
            <button id="next">Next</button>
          </div>
        </div>
        <div style="overflow:auto; max-height:70vh;">
          <table aria-label="Filtered releases">
            <thead>
              <tr id="thead">
                <th data-key="artist">Artist Name<span class="dir" aria-hidden="true"></span></th>
                <th data-key="release">Release Name<span class="dir" aria-hidden="true"></span></th>
                <th data-key="country">Artist Country<span class="dir" aria-hidden="true"></span></th>
                <th data-key="date">Release Date<span class="dir" aria-hidden="true"></span></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Right: charts -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="panel"><canvas id="chartTopArtists" height="160"></canvas></div>
        <div class="panel"><canvas id="chartTopCountries" height="160"></canvas></div>
      </div>
    </div>
  </main>

  <script>
    // ---------- state ----------
    const els = {
      q: document.getElementById('q'),
      country: document.getElementById('country'),
      start: document.getElementById('start'),
      end: document.getElementById('end'),
      clear: document.getElementById('clear'),
      status: document.getElementById('status'),
      summary: document.getElementById('summary'),
      tbody: document.getElementById('tbody'),
      thead: document.getElementById('thead'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      chartA: document.getElementById('chartTopArtists'),
      chartC: document.getElementById('chartTopCountries')
    };

    const PAGE_SIZE = 100;
    let sortBy = 'date';
    let sortDir = 'desc';
    let offset = 0;
    let total = 0;

    let charts = {};

    // ---------- utils ----------
    const uniqSorted = a => Array.from(new Set(a.filter(Boolean))).sort((x,y)=>x.localeCompare(y));
    const selected = sel => Array.from(sel.selectedOptions).map(o=>o.value);
    const fmtDate = iso => {
      const d = new Date(iso); if(isNaN(d)) return '';
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    function setHeaderIcons(){
      document.querySelectorAll('th[data-key] .dir').forEach(el=>el.textContent='');
      const th = document.querySelector(`th[data-key="${sortBy}"] .dir`);
      if (th) th.textContent = sortDir === 'asc' ? '▲' : '▼';
    }
    function statusLine(offset, limit, total, page){
      const start = total ? offset + 1 : 0;
      const end   = Math.min(offset + limit, total);
      const pages = total ? Math.ceil(total / limit) : 0;
      return `${start.toLocaleString()} - ${end.toLocaleString()} of ${total.toLocaleString()} (Page ${page.toLocaleString()} / ${pages.toLocaleString()})`;
    }

    async function fetchJSON(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${url}`);
      return res.json();
    }

    // ---------- initial load to get filter ranges ----------
    async function loadFilterOptions(){
      // Fetch a big slice just to get date/country ranges; you can add a dedicated options endpoint later if needed.
      const url = new URL('/api/releases', location.origin);
      url.searchParams.set('limit', '1000');
      url.searchParams.set('sortBy', 'date');
      url.searchParams.set('sortDir', 'asc');
      const { results=[] } = await fetchJSON(url);
      const countries = uniqSorted(results.map(r=>r.country));
      els.country.innerHTML='';
      for(const c of countries){ const o=document.createElement('option'); o.value=c; o.textContent=c; els.country.appendChild(o); }

      // date range
      if (results.length){
        const ys = results.map(r=>new Date(r.date).getFullYear());
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        els.start.value = `${minY}-01-01`;
        els.end.value   = `${maxY}-12-31`;
      }
    }

    function buildQuery(){
      const u = new URL('/api/releases', location.origin);
      const qv = els.q.value.trim();
      const cn = selected(els.country);
      if (qv) u.searchParams.set('q', qv);
      cn.forEach(c=>u.searchParams.append('country', c));
      if (els.start.value) u.searchParams.set('start', els.start.value);
      if (els.end.value)   u.searchParams.set('end',   els.end.value);
      u.searchParams.set('limit', PAGE_SIZE.toString());
      u.searchParams.set('offset', offset.toString());
      u.searchParams.set('sortBy', sortBy);
      u.searchParams.set('sortDir', sortDir);
      return u.toString();
    }

    async function loadPage(){
      els.status.textContent = 'Loading…';
      const data = await fetchJSON(buildQuery());
      total = data.total || 0;

      renderTable(data.results || []);
      renderStatus();
      renderCharts(data.results || []);

      // pager buttons
      els.prev.disabled = (offset === 0);
      els.next.disabled = (offset + PAGE_SIZE >= total);

      setHeaderIcons();
      els.status.textContent = '';
    }

    function renderStatus(){
      const page = Math.floor(offset / PAGE_SIZE) + 1;
      els.summary.textContent = statusLine(offset, PAGE_SIZE, total, page);
    }

    function renderTable(rows){
      els.tbody.innerHTML = '';
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.artist || ''}</td>
          <td>${r.release || ''}</td>
          <td>${r.country || ''}</td>
          <td>${fmtDate(r.date)}</td>
        `;
        els.tbody.appendChild(tr);
      }
    }

    function makeOrUpdateChart(key, ctx, config){
      if (charts[key]) charts[key].destroy();
      charts[key] = new Chart(ctx, config);
    }

    function renderCharts(rows){
      // Top 5 Artist - by Release Count (on current page selection)
      const byArtist = {};
      for (const r of rows) byArtist[r.artist] = (byArtist[r.artist]||0) + 1;
      const topA = Object.entries(byArtist).sort((a,b)=>b[1]-a[1]).slice(0,5);
      makeOrUpdateChart('A',
        els.chartA.getContext('2d'),
        { type:'bar',
          data:{ labels: topA.map(x=>x[0]), datasets:[{ label:'Releases', data: topA.map(x=>x[1]) }] },
          options:{ plugins:{ title:{ display:true, text:'Top 5 Artist - by Release Count' }}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}}
        });

      // Top 5 Countries - by Release Count (on current page selection)
      const byCountry = {};
      for (const r of rows) { const c = r.country || 'Unknown'; byCountry[c] = (byCountry[c]||0) + 1; }
      const topC = Object.entries(byCountry).sort((a,b)=>b[1]-a[1]).slice(0,5);
      makeOrUpdateChart('C',
        els.chartC.getContext('2d'),
        { type:'bar',
          data:{ labels: topC.map(x=>x[0]), datasets:[{ label:'Total Releases', data: topC.map(x=>x[1]) }] },
          options:{ plugins:{ title:{ display:true, text:'Top 5 Countries - by Release Count' }}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}}
        });
    }

    // ---------- events ----------
    const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    // sort on header click
    els.thead.addEventListener('click', (e)=>{
      const th = e.target.closest('th[data-key]');
      if (!th) return;
      const key = th.getAttribute('data-key');
      if (sortBy === key){ sortDir = (sortDir === 'asc' ? 'desc' : 'asc'); }
      else { sortBy = key; sortDir = (key === 'date' ? 'desc' : 'asc'); }
      offset = 0; // reset to page 1 on sort change
      loadPage().catch(console.error);
    });

    // filters
    els.q.addEventListener('input', debounce(()=>{ offset=0; loadPage().catch(console.error); }, 250));
    els.country.addEventListener('change', ()=>{ offset=0; loadPage().catch(console.error); });
    els.start.addEventListener('change',  ()=>{ offset=0; loadPage().catch(console.error); });
    els.end.addEventListener('change',    ()=>{ offset=0; loadPage().catch(console.error); });

    // clear filters
    els.clear.addEventListener('click', async ()=>{
      els.q.value = '';
      Array.from(els.country.options).forEach(o=>o.selected=false);
      // reset dates to full known range by peeking 1k oldest/newest
      await loadFilterOptions();
      sortBy = 'date'; sortDir = 'desc'; offset = 0;
      loadPage().catch(console.error);
    });

    // pagination
    els.prev.addEventListener('click', ()=>{
      offset = Math.max(0, offset - PAGE_SIZE);
      loadPage().catch(console.error);
    });
    els.next.addEventListener('click', ()=>{
      offset = Math.min(Math.max(0, total - PAGE_SIZE), offset + PAGE_SIZE);
      loadPage().catch(console.error);
    });

    // ---------- boot ----------
    (async ()=>{
      try {
        await loadFilterOptions(); // to fill countries + default dates
        await loadPage();
      } catch (e) {
        els.status.innerHTML = `<span class="error">${String(e.message || e)}</span>`;
      }
    })();
  </script>
</body>
</html>
