<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MENA Releases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 1rem; background: #f5f5f5; }
    h1 { margin: 0; font-size: 1.8rem; }
    .sub { margin-top: 4px; }
    main { display: flex; flex-wrap: wrap; padding: 1rem; gap: 1rem; }
    #table-container { flex: 2 1 600px; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; cursor: pointer; }
    td.wrap { white-space: normal; word-break: break-word; }
    #charts-container { flex: 1 1 400px; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    label { display: flex; flex-direction: column; font-size: 0.9rem; }
    @media (max-width: 768px) {
      main { flex-direction: column; }
      .date-range { display: flex; gap: 0.5rem; }
    }
  </style>
</head>
<body>
<header>
  <h1>MENA Releases</h1>
  <div class="sub" style="font-size: 1rem;">
    brought to you by <strong>MENAMUSICINDUSTRY</strong> meme page. Data powered by <strong>MusicBrainz</strong>.
  </div>
  <div class="sub" style="font-size: 0.85rem; margin-top: 3px;">
    Follow me on Instagram:
    <a href="https://www.instagram.com/YOUR_INSTAGRAM_USERNAME" 
       target="_blank" 
       rel="noopener noreferrer">
       @YOUR_INSTAGRAM_USERNAME
    </a>
  </div>
  <div class="sub" style="font-size: 0.75rem; margin-top: 2px; color: #777;">
    database is updated weekly or whenever I feel like it
  </div>

  <div class="controls">
    <label>Artist Name
      <input id="artist" type="text">
    </label>
    <label>Artist Country
      <select id="country" multiple></select>
    </label>
    <div class="date-range">
      <label>Release Date (start)
        <input id="start" type="date">
      </label>
      <label>Release Date (end)
        <input id="end" type="date">
      </label>
    </div>
    <button id="clear">Clear Filters</button>
  </div>
</header>

<main>
  <div id="table-container">
    <table id="releases">
      <thead>
        <tr>
          <th data-col="artist">Artist Name</th>
          <th data-col="release">Release Name</th>
          <th data-col="country">Artist Country</th>
          <th data-col="date">Release Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pagination"></div>
  </div>
  <div id="charts-container">
    <canvas id="chart-artists"></canvas>
    <canvas id="chart-countries"></canvas>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const els = {
  artist: document.getElementById('artist'),
  country: document.getElementById('country'),
  start: document.getElementById('start'),
  end: document.getElementById('end'),
  clear: document.getElementById('clear'),
  tbody: document.querySelector('#releases tbody'),
  pagination: document.getElementById('pagination')
};

function fmtDate(d){ return new Date(d).toISOString().slice(0,10); }
async function fetchJSON(url){ const r = await fetch(url); return r.json(); }

async function loadFilterOptions(){
  const { countries = [], minDate = null, maxDate = null } =
    await fetchJSON('/api/options');

  els.country.innerHTML = '';
  for (const c of countries){
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    els.country.appendChild(o);
  }
  if (minDate) els.start.value = fmtDate(minDate);
  if (maxDate) els.end.value = fmtDate(maxDate);
}

let currentPage = 1, pageSize = 100, totalRows = 0;

async function loadPage(){
  const params = new URLSearchParams();
  if (els.artist.value) params.append('artist', els.artist.value);
  if (els.country.selectedOptions.length)
    params.append('country', Array.from(els.country.selectedOptions).map(o=>o.value).join(','));
  if (els.start.value) params.append('start', els.start.value);
  if (els.end.value) params.append('end', els.end.value);
  params.append('page', currentPage);
  params.append('size', pageSize);

  const data = await fetchJSON('/api/releases?' + params.toString());
  totalRows = data.total;
  els.tbody.innerHTML = '';
  for (const r of data.rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.artist}</td>
      <td class="wrap">${r.release}</td>
      <td>${r.country}</td>
      <td>${r.date || ''}</td>
    `;
    els.tbody.appendChild(tr);
  }
  renderPagination();
  updateCharts(data.stats);
}

function renderPagination(){
  const totalPages = Math.ceil(totalRows / pageSize);
  els.pagination.textContent = `${(currentPage-1)*pageSize+1} - ${Math.min(currentPage*pageSize,totalRows)} of ${totalRows} (Page ${currentPage} / ${totalPages})`;
}

let chartArtists, chartCountries;
function updateCharts(stats){
  const ctxA = document.getElementById('chart-artists').getContext('2d');
  const ctxC = document.getElementById('chart-countries').getContext('2d');
  if (chartArtists) chartArtists.destroy();
  if (chartCountries) chartCountries.destroy();
  chartArtists = new Chart(ctxA, {
    type: 'bar',
    data: { labels: stats.topArtists.labels, datasets: [{ label: 'Top 5 Artists - by Release Count', data: stats.topArtists.data }] },
  });
  chartCountries = new Chart(ctxC, {
    type: 'bar',
    data: { labels: stats.topCountries.labels, datasets: [{ label: 'Top 5 Countries - by Release Count', data: stats.topCountries.data }] },
  });
}

els.clear.addEventListener('click', ()=>{
  els.artist.value = '';
  Array.from(els.country.options).forEach(o=>o.selected=false);
  loadFilterOptions();
  currentPage = 1;
  loadPage();
});

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadFilterOptions();
  await loadPage();
});
</script>
</body>
</html>
